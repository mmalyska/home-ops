- name: Apply package configuration
  ansible.builtin.include_tasks: packages.yml
  tags:
    - packages
    - prepare

- name: Run checks
  ansible.builtin.include_tasks: checks.yml
  tags:
    - checks
    - prepare

- name: Apply locales
  ansible.builtin.include_tasks: locale.yml
  tags:
    - locale
    - prepare

- name: Apply network configuration
  ansible.builtin.include_tasks: network.yml
  tags:
    - network
    - prepare

- name: Combine sysctl_settings and sysctl_settings_user (if defined)
  ansible.builtin.set_fact:
    sysctl_settings: "{{ sysctl_settings | combine(sysctl_settings_user | default({})) }}"
  tags:
    - sysctl

- name: Sysctl settings
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: "{{ sysctl_settings[item] }}"
    sysctl_set: true
  loop: "{{ sysctl_settings | flatten }}"
  notify: netplan apply config
  tags:
    - sysctl

- name: "Flush handlers"
  ansible.builtin.meta: flush_handlers
