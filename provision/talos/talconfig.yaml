clusterName: &clusterName home

# renovate: datasource=github-releases depName=mmalyska/talos-images
talosVersion: v1.8.4
# renovate: datasource=github-releases depName=siderolabs/kubelet
kubernetesVersion: v1.31.4

endpoint: https://${clusterDomain}:6443

cniConfig:
  name: none

additionalMachineCertSans: &sans
  - &talosControlplaneVip ${clusterEndpointIP}
  - ${clusterDomain}
  - 127.0.0.1 # KubePrism
additionalApiServerCertSans: *sans

nodes:
  - hostname: mc1
    ipAddress: 192.168.48.2
    installDisk: /dev/nvme0n1
    controlPlane: true
    networkInterfaces:
      - interface: eth0
        addresses:
          - 192.168.48.2/22
        mtu: 1500
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.50.1
        vip:
          ip: *talosControlplaneVip
  - hostname: mc2
    ipAddress: 192.168.48.3
    installDisk: /dev/nvme0n1
    controlPlane: true
    networkInterfaces:
      - interface: eth0
        addresses:
          - 192.168.48.3/22
        mtu: 1500
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.50.1
        vip:
          ip: *talosControlplaneVip
  - hostname: mc3
    ipAddress: 192.168.48.4
    installDisk: /dev/nvme0n1
    controlPlane: true
    networkInterfaces:
      - interface: eth0
        addresses:
          - 192.168.48.4/22
        mtu: 1500
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.50.1
        vip:
          ip: *talosControlplaneVip

controlPlane:
  nodeLabels:
    topology.kubernetes.io/region: *clusterName
    topology.kubernetes.io/zone: m

  patches:
    - |-
      cluster:
        extraManifests:
          # Install the kubelet cert-approver manifests
          - https://raw.githubusercontent.com/mmalyska/home-ops/main/provision/talos/manifests/kubelet-csr-approver/kubelet-csr-approver.yaml
        allowSchedulingOnMasters: true
        apiServer:
          extraArgs:
            oidc-client-id: ${oidcClientId}
            oidc-groups-claim: groups
            oidc-groups-prefix: 'oidc:'
            oidc-issuer-url: ${oidcIssuerURL}
            oidc-username-claim: email
            oidc-username-prefix: 'oidc:'
        proxy:
          disabled: true
    - |-
      machine:
        files:
          - op: create
            path: /etc/cri/conf.d/20-customization.part
            content: |
              [plugins]
                [plugins."io.containerd.grpc.v1.cri"]
                  enable_unprivileged_ports = true
                  enable_unprivileged_icmp = true
              [plugins."io.containerd.grpc.v1.cri".containerd]
                discard_unpacked_layers = false
              [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                discard_unpacked_layers = false
        kubelet:
          extraArgs:
            feature-gates: GracefulNodeShutdown=true
            rotate-server-certificates: "true"
        time:
          disabled: false
          servers:
            - 192.168.50.1
        sysctls:
          fs.inotify.max_user_instances: 8192    # Watchdog
          fs.inotify.max_user_watches: 1048576   # Watchdog
          net.core.rmem_max: 67108864            # Cloudflared / QUIC
          net.core.wmem_max: 67108864            # Cloudflared / QUIC
        install:
          # renovate-docker
          image: ghcr.io/mmalyska/talos-installer:v1.8.4@sha256:910e0fa94ab0574c23e5666f64e9aeb40614138c573a6208a02d6415ecd8afd6
          extraKernelArgs:
            - net.ifnames=0
        features:
          kubernetesTalosAPIAccess:
            enabled: true
            allowedRoles:
              - os:etcd:backup
            allowedKubernetesNamespaces:
              - talos-backup
          hostDNS:
            enabled: true
            resolveMemberNames: true
            forwardKubeDNSToHost: true
          kubePrism:
            enabled: true
            port: 7445
        network:
          nameservers:
            - 192.168.50.9
    - |-
      - op: add
        path: /cluster/controllerManager/extraArgs
        value:
          bind-address: 0.0.0.0
      - op: add
        path: /cluster/scheduler/extraArgs
        value:
          bind-address: 0.0.0.0
      - op: add
        path: /cluster/proxy/extraArgs
        value:
          bind-address: 0.0.0.0
