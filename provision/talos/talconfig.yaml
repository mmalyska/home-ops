clusterName: home
talosVersion: v1.4.3
# renovate: datasource=github-releases depName=kubernetes/kubernetes
kubernetesVersion: v1.27.2
endpoint: https://${clusterDomain}:6443
cniConfig:
  name: flannel
additionalMachineCertSans:
  - ${clusterEndpointIP}
  - ${clusterDomain}
additionalApiServerCertSans:
  - ${clusterEndpointIP}
nodes:
  - hostname: mc1
    ipAddress: 192.168.48.2
    installDisk: /dev/nvme0n1
    controlPlane: true
    nameservers:
      - 192.168.50.9
    networkInterfaces:
      - interface: eth0
        addresses:
          - 192.168.48.2/22
        mtu: 1500
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.50.1
        vip:
          ip: 192.168.48.1
  - hostname: mc2
    ipAddress: 192.168.48.3
    installDisk: /dev/nvme0n1
    controlPlane: true
    nameservers:
      - 192.168.50.9
    networkInterfaces:
      - interface: eth0
        addresses:
          - 192.168.48.3/22
        mtu: 1500
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.50.1
        vip:
          ip: 192.168.48.1
  - hostname: mc3
    ipAddress: 192.168.48.4
    installDisk: /dev/nvme0n1
    controlPlane: true
    nameservers:
      - 192.168.50.9
    networkInterfaces:
      - interface: eth0
        addresses:
          - 192.168.48.4/22
        mtu: 1500
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.50.1
        vip:
          ip: 192.168.48.1
controlPlane:
  inlinePatch:
    machine:
      install:
        extensions:
          - image: ghcr.io/siderolabs/i915-ucode:20230310
          - image: ghcr.io/siderolabs/intel-ucode:20230214
  patches:
    - |-
      cluster:
        extraManifests:
          # Install the kubelet cert-approver manifests
          - https://raw.githubusercontent.com/mmalyska/home-ops/main/provision/talos/manifests/kubelet-csr-approver/kubelet-csr-approver.yaml
        allowSchedulingOnMasters: true
        apiServer:
          extraArgs:
            oidc-client-id: ${oidcClientId}
            oidc-groups-claim: groups
            oidc-groups-prefix: 'oidc:'
            oidc-issuer-url: ${oidcIssuerURL}
            oidc-username-claim: email
            oidc-username-prefix: 'oidc:'
    - |-
      machine:
        kubelet:
          extraArgs:
            feature-gates: CronJobTimeZone=true,GracefulNodeShutdown=true
            rotate-server-certificates: "true"
        time:
          disabled: false
          servers:
            - 192.168.50.1
    - |-
      - op: add
        path: /cluster/controllerManager/extraArgs
        value:
          bind-address: 0.0.0.0
      - op: add
        path: /cluster/scheduler/extraArgs
        value:
          bind-address: 0.0.0.0
      - op: add
        path: /cluster/proxy/extraArgs
        value:
          bind-address: 0.0.0.0
