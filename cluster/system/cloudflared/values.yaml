app-template:
  controller:
    replicas: 2
    strategy: RollingUpdate
  image:
    repository: docker.io/cloudflare/cloudflared
    tag: 2023.7.1@sha256:cd7e3e663b0c0c7c3eec298f19c183eb2ae73946f1a5e825e5b335bc72e29115
  env:
    TUNNEL_LOGLEVEL: debug
    NO_AUTOUPDATE: "true"
    TUNNEL_METRICS: 0.0.0.0:8080
    TUNNEL_TRANSPORT_PROTOCOL: auto
    TUNNEL_TOKEN:
      valueFrom:
        secretKeyRef:
          name: cloudflared-secret
          key: token
  args:
    - tunnel
    - run
  service:
    main:
      ports:
        http:
          port: 8080
  serviceMonitor:
    main:
      enabled: true
      endpoints:
        - port: http
          scheme: http
          path: /metrics
          interval: 1m
          scrapeTimeout: 30s
  probes:
    liveness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /ready
          port: http
        initialDelaySeconds: 0
        periodSeconds: 10
        timeoutSeconds: 1
        failureThreshold: 3
    readiness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /ready
          port: http
        initialDelaySeconds: 0
        periodSeconds: 10
        timeoutSeconds: 1
        failureThreshold: 3
    startup:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /ready
          port: http
        failureThreshold: 30
        periodSeconds: 10
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: cloudflared
  resources:
    requests:
      cpu: 6m
      memory: 105Mi
    limits:
      memory: 105Mi
