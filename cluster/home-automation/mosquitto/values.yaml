app-template:
  controllers:
    main:
      strategy: Recreate
      containers:
        main:
          image:
            repository: public.ecr.aws/docker/library/eclipse-mosquitto
            tag: 2.0.18@sha256:ddf2025790f12e23cf8750c1d2188a9511641d7676e7c70350e105c79fe1bef7
            pullPolicy: IfNotPresent
      initContainers:
        copy-config:
          image:
            repository: public.ecr.aws/docker/library/eclipse-mosquitto
            tag: 2.0.18@sha256:ddf2025790f12e23cf8750c1d2188a9511641d7676e7c70350e105c79fe1bef7
            pullPolicy: IfNotPresent
          command:
            - "/bin/sh"
            - -c
          args:
            - cp /data/mosquitto_secret/* /data/external_config/ && mosquitto_passwd -U /data/external_config/mosquitto_pwd
          volumeMounts:
            - name: mosquitto-secret
              mountPath: /data/mosquitto_secret
            - name: external-config
              mountPath: /data/external_config
  service:
    main:
      type: LoadBalancer
      annotations:
        metallb.universe.tf/loadBalancerIPs: "192.168.48.26"
      externalTrafficPolicy: Cluster
      ports:
        http:
          enabled: false
        mqtt:
          enabled: true
          port: 1883
  persistence:
    mosquitto-config:
      enabled: true
      type: configMap
      name: mosquitto-configmap
      advancedMounts:
        main:
          main:
            - path: /mosquitto/config/mosquitto.conf
              subPath: mosquitto.conf
    mosquitto-secret:
      enabled: true
      type: secret
      name: mosquitto-secret
      advancedMounts:
        main:
          copy-config:
            - path: "-"
    external-config:
      enabled: true
      type: emptyDir
      advancedMounts:
        main:
          main:
            - path: /mosquitto/external_config
          copy-config:
            - path: /mosquitto/external_config
  resources:
    requests:
      cpu: 5m
      memory: 10M
    limits:
      memory: 10M
  volumeClaimTemplates:
    - name: data
      mountPath: /data
      size: 512Mi
